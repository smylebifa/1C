
&НаКлиенте
Процедура ПриОткрытии(Отказ)
  ПутьФайла = "D:\выгрузка.txt";    
КонецПроцедуры


&НаКлиенте
Процедура ПросмотрФайла(Команда)  
  ЗапуститьПриложение(Объект.ПутьФайла);  
КонецПроцедуры


&НаКлиенте
Процедура Выгрузить(Команда) 
  ЗаписатьВТекстовыйФайлДокумент(Объект.Документ);    
КонецПроцедуры  


&НаСервере
Процедура ЗаписатьВТекстовыйФайлДокумент(ОбъектДокумент)
  
  ТекстФайла = Новый ТекстовыйДокумент; 
  
  Если ЗначениеЗаполнено(Объект.ПутьФайла) И ЗначениеЗаполнено(Объект.Документ) Тогда
    ПутьФайла = Объект.ПутьФайла;
    
    МетаданныеДокумента = ОбъектДокумент.Метаданные();
    
    ТекстФайла.ДобавитьСтроку("" + МетаданныеДокумента.Имя);
    
    Если ОбъектДокумент.Проведен Тогда
      ТекстФайла.ДобавитьСтроку("Проведен>>Да");          
    Иначе
      ТекстФайла.ДобавитьСтроку("Проведен>>Нет"); 
    КонецЕсли;  
    
    ТекстФайла.ДобавитьСтроку("ДатаДокумента>>" + ОбъектДокумент.Дата);           
    
    
    Для Каждого РеквизитМетаданных Из МетаданныеДокумента.Реквизиты Цикл    
      Если ЗначениеЗаполнено(ОбъектДокумент[РеквизитМетаданных.Имя]) Тогда 
        Если ЭтоДокумент(ОбъектДокумент[РеквизитМетаданных.Имя]) = Истина Тогда
          
          СтрокаТипа = ОбъектДокумент[РеквизитМетаданных.Имя].Метаданные().ПолноеИмя();
          Разделитель = СтрНайти(СтрокаТипа, ".");
          ТипДанных1 = Сред(СтрокаТипа, 1, Разделитель - 1);
          ТипДанных2 = Сред(СтрокаТипа, Разделитель + 1, СтрДлина(СтрокаТипа));
          
          ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + 
          ОбъектДокумент[РеквизитМетаданных.Имя] + ">>" + ТипДанных1 + ">>" + ТипДанных2 + ">>" + 
          ОбъектДокумент[РеквизитМетаданных.Имя].Номер + ">>" + ОбъектДокумент[РеквизитМетаданных.Имя].Дата);
          
        ИначеЕсли ТипЗнч(ОбъектДокумент[РеквизитМетаданных.Имя]) <> Тип("Строка") 
          И ТипЗнч(ОбъектДокумент[РеквизитМетаданных.Имя]) <> Тип("Число")
          И ТипЗнч(ОбъектДокумент[РеквизитМетаданных.Имя]) <> Тип("Дата")
          И ТипЗнч(ОбъектДокумент[РеквизитМетаданных.Имя]) <> Тип("Булево") Тогда
          
          СтрокаТипа = ОбъектДокумент[РеквизитМетаданных.Имя].Метаданные().ПолноеИмя();
          Разделитель = СтрНайти(СтрокаТипа, ".");
          ТипДанных1 = Сред(СтрокаТипа, 1, Разделитель - 1);
          ТипДанных2 = Сред(СтрокаТипа, Разделитель + 1, СтрДлина(СтрокаТипа));
          
          Данные = ОбъектДокумент[РеквизитМетаданных.Имя];
          ДанныеОбработанные = СтрЗаменить(Данные, Символы.ПС,"");
          ДанныеОбработанные = СтрЗаменить(ДанныеОбработанные, Символы.ВК,"");
          
          Если Строка(Данные) <> ДанныеОбработанные Тогда
            ТекстФайла.ДобавитьСтроку("<<>>");
            
            ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные 
            + ">>" + ТипДанных1 + ">>" + ТипДанных2);
            
            ТекстФайла.ДобавитьСтроку("<<>>");
            
          Иначе 
            
            Попытка
              Если ЗначениеЗаполнено(ОбъектДокумент[РеквизитМетаданных.Имя].Код) Тогда
                ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные 
                + ">>" + ТипДанных1 + ">>" + ТипДанных2 + ">>" + ОбъектДокумент[РеквизитМетаданных.Имя].Код);
              Иначе
                ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные 
                + ">>" + ТипДанных1 + ">>" + ТипДанных2);
              КонецЕсли;  
            Исключение
              ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные 
              + ">>" + ТипДанных1 + ">>" + ТипДанных2); 
            КонецПопытки;
          КонецЕсли;
          
        Иначе                                                             
          Данные = ОбъектДокумент[РеквизитМетаданных.Имя];
          ДанныеОбработанные = СтрЗаменить(Данные, Символы.ПС,"");
          ДанныеОбработанные = СтрЗаменить(ДанныеОбработанные, Символы.ВК,""); 
          
          Если Строка(Данные) <> ДанныеОбработанные Тогда
            ТекстФайла.ДобавитьСтроку("<<>>");
            
            ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные);
            
            ТекстФайла.ДобавитьСтроку("<<>>");
            
          Иначе 
            ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + Данные);
          КонецЕсли;
          
        КонецЕсли;
        
      КонецЕсли;      
    КонецЦикла; 
    
    Для Каждого ТабличнаяЧасть Из МетаданныеДокумента.ТабличныеЧасти Цикл   
      Если ЗначениеЗаполнено(ОбъектДокумент[ТабличнаяЧасть.Имя]) Тогда
        ТекстФайла.ДобавитьСтроку("" + ТабличнаяЧасть.Имя + ">>" + ОбъектДокумент[ТабличнаяЧасть.Имя]);       
      КонецЕсли;  
      
      НомерСтроки = 1;
      Для Каждого СтрокаТабличнойЧасти ИЗ ОбъектДокумент[ТабличнаяЧасть.Имя] Цикл
        ТекстФайла.ДобавитьСтроку("НомерСтроки>>" + Строка(НомерСтроки));
        Для Каждого РеквизитМетаданных ИЗ ТабличнаяЧасть.Реквизиты Цикл 
          Если ТипЗнч(ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя]) <> Тип("Строка") 
            И ТипЗнч(ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя]) <> Тип("Число")
            И ТипЗнч(ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя]) <> Тип("Дата")
            И ТипЗнч(ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя]) <> Тип("Булево")
            И ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя] <> Неопределено Тогда  
            
            
            Если ЭтоДокумент(ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя]) = Истина Тогда 
              СтрокаТипа = ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя].Метаданные().ПолноеИмя();
              Разделитель = СтрНайти(СтрокаТипа, ".");
              ТипДанных1 = Сред(СтрокаТипа, 1, Разделитель - 1);
              ТипДанных2 = Сред(СтрокаТипа, Разделитель + 1, СтрДлина(СтрокаТипа));
              ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + 
              СтрокаТабличнойЧасти[РеквизитМетаданных.Имя] + ">>" + 
              ТипДанных1 + ">>" + ТипДанных2 + ">>" +
              СтрокаТабличнойЧасти[РеквизитМетаданных.Имя].Номер + ">>" + СтрокаТабличнойЧасти[РеквизитМетаданных.Имя].Дата );              
              
            Иначе
              СтрокаТипа = ОбъектДокумент[ТабличнаяЧасть.Имя][0][РеквизитМетаданных.Имя].Метаданные().ПолноеИмя();
              Разделитель = СтрНайти(СтрокаТипа, ".");
              ТипДанных1 = Сред(СтрокаТипа, 1, Разделитель - 1);
              ТипДанных2 = Сред(СтрокаТипа, Разделитель + 1, СтрДлина(СтрокаТипа));
              ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + 
              СтрокаТабличнойЧасти[РеквизитМетаданных.Имя] + ">>" + ТипДанных1 + ">>" + ТипДанных2);              
              
            КонецЕсли;
            
            
          Иначе
            ТекстФайла.ДобавитьСтроку("" + РеквизитМетаданных.Имя + ">>" + СтрокаТабличнойЧасти[РеквизитМетаданных.Имя]);               
            
          КонецЕсли;
          
        КонецЦикла;
        НомерСтроки = НомерСтроки + 1;
      КонецЦикла;
      
    КонецЦикла; 
    
    ТекстФайла.Записать(ПутьФайла); 
    
    Сообщить("Объект был выгружен");
    
  Иначе 
    Если Не ЗначениеЗаполнено(Объект.Документ) Тогда
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = "Документ не выбран";
      Сообщение.Поле = "Объект.Документ";
      Сообщение.УстановитьДанные(Объект.Документ);
      Сообщение.Сообщить();
    КонецЕсли;
    
    Если Не ЗначениеЗаполнено(Объект.ПутьФайла) Тогда
      Сообщение = Новый СообщениеПользователю;
      Сообщение.Текст = "Путь к файлу не выбран";
      Сообщение.Поле = "Объект.ПутьФайла";
      Сообщение.УстановитьДанные(Объект.ПутьФайла);
      Сообщение.Сообщить();
    КонецЕсли;
    
    
  КонецЕсли;  
  
КонецПроцедуры 

&НаКлиенте
Процедура Загрузить(Команда)   
  
  СоздатьДокументИзФайла();
  
КонецПроцедуры 


&НаСервере
Процедура СоздатьДокументИзФайла()
  
  Если ЗначениеЗаполнено(Объект.ПутьФайла) Тогда
    ПутьФайла = Объект.ПутьФайла;
    ВыбранныйФайл = Новый Файл(ПутьФайла);  
    
    Если ВыбранныйФайл.Существует() Тогда
      ТекстовыйФайл = Новый ЧтениеТекста(ПутьФайла);
      
      Строка = ТекстовыйФайл.ПрочитатьСтроку();  
      
      Если Строка <> Неопределено Тогда
        
        НовыйДокумент = Документы[Строка].СоздатьДокумент();
        
        МетаданныеДокумента = НовыйДокумент.Метаданные();
        
        НазванияТабличныхЧастей = Новый Массив;       
        НазванияРеквизитовТабличныхЧастей = Новый Массив;
        
        Для каждого ТабличнаяЧастьДокумента Из МетаданныеДокумента.ТабличныеЧасти Цикл
          
          НазванияТабличныхЧастей.Добавить(ТабличнаяЧастьДокумента.Имя);  
          
          Для каждого РеквизитТабличнойЧастиДокумента Из ТабличнаяЧастьДокумента.Реквизиты Цикл
            
            Если НазванияРеквизитовТабличныхЧастей.Найти(РеквизитТабличнойЧастиДокумента) = Неопределено Тогда
              НазванияРеквизитовТабличныхЧастей.Добавить(РеквизитТабличнойЧастиДокумента.Имя);                                              
            КонецЕсли;  
            
          КонецЦикла;
          
        КонецЦикла; 
        
        Строка = ТекстовыйФайл.ПрочитатьСтроку();
        
        Пока Строка <> Неопределено Цикл      
          
          МассивСтрок = СтрРазделить(Строка, ">>");
          
          Если НазванияТабличныхЧастей.Найти(МассивСтрок[0]) <> Неопределено Тогда
            ТекущаяТабличнаяЧасть = МассивСтрок[0];
            
          ИначеЕсли МассивСтрок[0] = "НомерСтроки" Тогда 
            НоваяСтрока = НовыйДокумент[ТекущаяТабличнаяЧасть].Добавить();
            
          ИначеЕсли МассивСтрок[0] = "Проведен" Тогда 
            ДокументПроведен = МассивСтрок[2];
            
          ИначеЕсли МассивСтрок[0] = "ДатаДокумента" Тогда 
            НовыйДокумент.Дата = Дата(МассивСтрок[2]);
            
          ИначеЕсли МассивСтрок[0] = "<<" Тогда 
            
            Строка = ТекстовыйФайл.ПрочитатьСтроку();
            
            Разделитель = СтрНайти(Строка, ">>");
            
            МассивСтрок = СтрРазделить(Строка, ">>");
            
            Строка = ТекстовыйФайл.ПрочитатьСтроку();
            
            Пока Строка <> "<<>>" Цикл
              МассивСтрок[2] = МассивСтрок[2] + Символы.ПС + Строка ;
              Строка = ТекстовыйФайл.ПрочитатьСтроку();
            КонецЦикла;  
            
            Попытка
              НовыйДокумент[МассивСтрок[0]] = МассивСтрок[2];
            Исключение
              НоваяСтрока[МассивСтрок[0]] = МассивСтрок[2];
            КонецПопытки;
            
            // Реквизиты табличной части  
          ИначеЕсли НазванияРеквизитовТабличныхЧастей.Найти(МассивСтрок[0]) <> Неопределено  
            И ТекущаяТабличнаяЧасть <> Неопределено 
            И МетаданныеДокумента.Реквизиты.Найти(МассивСтрок[0]) = Неопределено Тогда 
            
            Если МассивСтрок.Количество() > 3 Тогда
              
              Если МассивСтрок[4] = "Справочник" Тогда                               
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда                       
                  Если МассивСтрок.Количество() > 8 Тогда 
                    Если ЗначениеЗаполнено(Справочники[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[8])) Тогда
                      НоваяСтрока[МассивСтрок[0]] = Справочники[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[8]);  
                    КонецЕсли;  
                  Иначе   
                    НоваяСтрока[МассивСтрок[0]] = Справочники[МассивСтрок[6]].НайтиПоНаименованию(МассивСтрок[2]);  
                  КонецЕсли;
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "Документ" Тогда   
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда 
                  НоваяСтрока[МассивСтрок[0]] = Документы[МассивСтрок[6]].НайтиПоНомеру(МассивСтрок[8], МассивСтрок[10]); 
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "Перечисление" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда 
                  НоваяСтрока[МассивСтрок[0]] = ВернутьЗначениеПеречисленияПоСинониму(МассивСтрок[6], МассивСтрок[2]); 
                КонецЕсли; 
                
              ИначеЕсли МассивСтрок[4] = "ПланСчетов" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда                   
                  НоваяСтрока[МассивСтрок[0]] = ПланыСчетов[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[2]);
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "ПланВидовХарактеристик" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда                   
                  НоваяСтрока[МассивСтрок[0]] = ПланыВидовХарактеристик[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[2]);
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "ПланВидовРасчета" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда                   
                  НоваяСтрока[МассивСтрок[0]] = ПланыВидовРасчета.Начисления.НайтиПоНаименованию(МассивСтрок[2]);
                КонецЕсли; 
              КонецЕсли;
              
            Иначе
              Если ЗначениеЗаполнено(МассивСтрок[2]) Тогда
                НоваяСтрока[МассивСтрок[0]] = МассивСтрок[2];             
              КонецЕсли;
            КонецЕсли;
            
            // Реквизиты документа
          Иначе 
            Если МассивСтрок.Количество() > 4 Тогда
              Если МассивСтрок[4] = "Справочник" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда          
                  Если МассивСтрок.Количество() > 8 Тогда 
                    Если ЗначениеЗаполнено(Справочники[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[8])) Тогда
                      НовыйДокумент[МассивСтрок[0]] = Справочники[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[8]);  
                    КонецЕсли;  
                  Иначе   
                    НовыйДокумент[МассивСтрок[0]] = Справочники[МассивСтрок[6]].НайтиПоНаименованию(МассивСтрок[2]); 
                  КонецЕсли;   
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "Документ" Тогда
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда
                  НовыйДокумент[МассивСтрок[0]] = Документы[МассивСтрок[6]].НайтиПоНомеру(МассивСтрок[8], МассивСтрок[10]);
                КонецЕсли;
                
              ИначеЕсли МассивСтрок[4] = "Перечисление" Тогда 
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда                 
                  НовыйДокумент[МассивСтрок[0]] = ВернутьЗначениеПеречисленияПоСинониму(МассивСтрок[6], МассивСтрок[2]);
                КонецЕсли;  
                
              ИначеЕсли МассивСтрок[4] = "ПланСчетов" Тогда 
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда 
                  НовыйДокумент[МассивСтрок[0]] = ПланыСчетов[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[2]);
                КонецЕсли;   
                
              ИначеЕсли МассивСтрок[4] = "ПланВидовХарактеристик" Тогда 
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда 
                  НовыйДокумент[МассивСтрок[0]] = ПланыВидовХарактеристик[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[2]);
                КонецЕсли;    
                
              ИначеЕсли МассивСтрок[4] = "ПланВидовРасчета" Тогда 
                Если ЗначениеЗаполнено(МассивСтрок[6]) Тогда 
                  НовыйДокумент[МассивСтрок[0]] = ПланыВидовРасчета[МассивСтрок[6]].НайтиПоКоду(МассивСтрок[2]);
                КонецЕсли;              
              КонецЕсли;
              
            Иначе 
              Если ЗначениеЗаполнено(МассивСтрок[2]) Тогда
                НовыйДокумент[МассивСтрок[0]] = МассивСтрок[2];
              КонецЕсли;
            КонецЕсли; 
            
          КонецЕсли;               
          
          Строка = ТекстовыйФайл.ПрочитатьСтроку();
          
        КонецЦикла;
        
        НовыйДокумент.УстановитьНовыйНомер();
        
        Если ДокументПроведен = "Да" ИЛИ ДокументПроведен = "да" Тогда
          Попытка
            НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный); 
          Исключение
            НовыйДокумент.Записать(РежимЗаписиДокумента.Запись, РежимПроведенияДокумента.Неоперативный);  
          КонецПопытки;
          Сообщить("Объект был загружен");
        Иначе
          НовыйДокумент.Записать(РежимЗаписиДокумента.Запись, РежимПроведенияДокумента.Неоперативный);  
          Сообщить("Объект был загружен");
        КонецЕсли;
        
        ТекстовыйФайл.Закрыть();      
        
      КонецЕсли;
      
    Иначе
      Сообщить("Файла не сущесвтует");  
    КонецЕсли;
    
  Иначе
    Сообщение = Новый СообщениеПользователю;
    Сообщение.Текст = "Путь к файлу не выбран";
    Сообщение.Поле = "Объект.ПутьФайла";
    Сообщение.Сообщить();   
  КонецЕсли; 
  
КонецПроцедуры  


Функция ВернутьЗначениеПеречисленияПоСинониму(Перечисление, Синоним)
  ЭлементПеречисления = Неопределено;
  Для каждого ТекЭлемент Из Метаданные.Перечисления[Перечисление].ЗначенияПеречисления Цикл
    Если ТекЭлемент.Синоним = Синоним Тогда
      ЭлементПеречисления = Перечисления[Перечисление][ТекЭлемент.Имя];
      Прервать;
    КонецЕсли;
  КонецЦикла; 
  
  Возврат ЭлементПеречисления;
КонецФункции 

Функция ЭтоДокумент(Значение)
  Возврат Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(Значение));
КонецФункции


&НаКлиенте
Процедура ПутьФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
  СтандартнаяОбработка = Ложь; 
  
  ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
  ДиалогВыбора.ПолноеИмяФайла = "выгрузка.txt";
  ДиалогВыбора.Фильтр = "Текст, *.txt|*.txt";
  ДиалогВыбора.Заголовок = "Выберите файл";
  
  Если ДиалогВыбора.Выбрать() Тогда
    Объект.ПутьФайла = ДиалогВыбора.ПолноеИмяФайла;
  КонецЕсли;
КонецПроцедуры

